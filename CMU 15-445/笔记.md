# CMU 15-445/645 ç¬”è®°

è¿™é‡Œæœ‰ä¸ªç¬”è®°å†™çš„å¾ˆå¥½çš„ç½‘ç«™ï¼Œä»¥åè¿˜æ˜¯çœ‹è¿™ä¸ªå§ï¼š

https://zhenghe.gitbook.io/open-courses/cmu-15-445-645-database-systems/

## 1.æ•°æ®åº“å‚¨å­˜

å¾…è¡¥



## 2. Bufferæ± ä¸å†…å­˜ç®¡ç†

å¾…è¡¥



## 3. Hash Table

### 3.1 Hash Tableçš„ç»„æˆ

ç”±hashå‡½æ•°å’Œhashæ¨¡å¼ç»„æˆ

![image-20220202110549811](images/image-20220202110549811.png)

#### 3.1.1 Hash Function

å¯¹äºhashå‡½æ•°ï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ˜¯ç¢°æ’ç‡å’Œé€Ÿåº¦

![image-20220202110711067](images/image-20220202110711067.png)

ä¸‹é¢æ˜¯å¸¸è§çš„æ•°æ®åº“ä½¿ç”¨çš„hashå‡½æ•°ï¼Œå…¶ä¸­**XXHASH**æ˜¯é€Ÿåº¦å’Œç¢°æ’ç‡éƒ½å¾ˆä¼˜ç§€çš„hashå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨è®¾è®¡æ•°æ®åº“çš„æ—¶å€™å¯ä»¥è€ƒè™‘è¯¥å‡½æ•°ã€‚

![image-20220202110811969](images/image-20220202110811969.png)

![image-20220202111142297](images/image-20220202111142297.png)

#### 3.1.2 Hashing Schemes

##### (1) Static Hashing Schemes

é™æ€hash schemes: å½“æˆ‘ä»¬åˆ†é…å†…å­˜æ—¶ï¼Œæˆ‘ä»¬ä¸€å¼€å§‹å°±å¾—çŸ¥é“æˆ‘ä»¬å¸Œæœ›ä¿å­˜çš„keyçš„æ•°é‡

ä¸‹é¢åˆ—å‡ºä¸‰ç§ static hashing schemes

* Linear Probe Hashing
* Robin Hood Hashing
* Cuckoo Hashing

###### Linear Probe Hashing

æ„é€ ä¸€ä¸ªåœ†å½¢æ•°ç»„ï¼Œé¦–å…ˆç”¨hashå‡½æ•°åˆ†é…åˆ°ä¸€ä¸ªoffsetï¼Œå¦‚æœè¯¥ä½ç½®æœ‰å…ƒç´ äº†åˆ™é¡ºåºå¾€ä¸‹æ‰«æç›´åˆ°é‡åˆ°ä¸€ä¸ªç©ºslotåˆ™æ”¾å…¥ï¼ŒæŸ¥è¯¢åŒç†ã€‚

å¦‚æœå…ƒç´ æ•°é‡ä¸ºnï¼Œåˆ™æ•°ç»„å¤§å°ä¸€èˆ¬ä¸º2*nï¼Œæ‰©å®¹ç±»ä¼¼ã€‚

![image-20220202112833150](images/image-20220202112833150.png)

è¿™é‡Œåˆ é™¤ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæä¾›ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

* ä¸ºåˆ é™¤ä½ç½®æ·»åŠ **å¢“ç¢‘æ ‡è®°**ï¼ˆæ¨èï¼‰
* æ•°æ®æ•´ä½“ç§»åŠ¨ï¼ˆäº‹å®ä¸Šï¼Œå¤„ç†ä¼šæ¯”è¾ƒéº»çƒ¦ï¼‰

###### Non-unique Keys

æœ‰æ—¶å€™æˆ‘ä»¬çš„key-valueé”®å€¼å¯¹ä¸æ˜¯å”¯ä¸€çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸€ä¸ªkeyå¯¹åº”ç€å¤šä¸ªvalue

![image-20220202114922337](images/image-20220202114922337.png)

###### Robin Hood Hashing

![image-20220202115120321](images/image-20220202115120321.png)

###### Cuckoo Hashing

è¿™ä¸ªhashæ–¹æ³•æ˜¯è®©æˆ‘ä»¬åˆ›å»ºå¤šä¸ªhash tableï¼Œæ¯ä¸ªhash tableæœ‰ä¸åŒçš„hashå‡½æ•°(åŒä¸€ä¸ªhashå‡½æ•°ä½†ä¸åŒçš„seedï¼Œä¸€èˆ¬æ¥è¯´ä¸¤ä¸ªhash tableè¶³çŸ£)ï¼Œå¯¹äºä¸€ä¸ªå…ƒç´ Aï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨æ¯ä¸ªhash tableæ‰¾åˆ°å¯¹åº”çš„offsetï¼Œå¦‚æœæœ‰ç©ºçš„slotåˆ™æ’å…¥(æœ‰å¤šä¸ªåˆ™éšæœºæ’å…¥ä¸€ä¸ª)ï¼Œå¦‚æœæ²¡æœ‰åˆ™éšæœºé€‰æ‹©ä¸€ä¸ªä½ç½®ï¼Œè®©å¯¹åº”ä½ç½®å…ƒç´ é‡æ–°hashï¼Œé‡æ–°é€‰æ‹©slotï¼Œç„¶åè¯¥å…ƒç´ æ’å…¥è¿›å»(å°±å¥½åƒæŠŠå®ƒä½ç½®æŠ¢å äº†ä¸€æ ·)ï¼Œå¦‚æœå›æº¯åˆ°èµ·ç‚¹ä»ç„¶æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¯´æ˜éœ€è¦æ‰©å®¹äº†ã€‚

![image-20220202120332736](images/image-20220202120332736.png)

##### (2) Dynamic Hashing Schemes

é™æ€hashåœ¨ä¿®æ”¹å¤§å°æ—¶å€™éœ€è¦å¯¹æ‰€æœ‰å…ƒç´ è¿›è¡Œé‡æ„(å¯ä»¥ç®€å•ç†è§£ä¸ºå…ƒç´ ä¸Šé™nå·²ç»æ”¹å˜äº†ï¼Œå³å–æ¨¡å€¼nå˜äº†)ï¼Œè¿™æ ·åœ¨æ¯æ¬¡é‡æ„çš„æ—¶å€™éå¸¸è´¹æ—¶ï¼ŒåŠ¨æ€hashåˆ™æ— éœ€é‡æ„æ•´ä¸ªhash tableè€Œæ ¹æ®éœ€è¦è°ƒæ•´å¤§å°ï¼Œä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸‰ç§åŠ¨æ€hashæ–¹æ³•

* Chained Hashing
* Extendible Hashing
* Linear Hashing

###### Chained Hashing

Chained Hashingå°±æ˜¯æŒ‚é“¾hashï¼ŒæŠŠå†²çªçš„å…ƒç´ ç”¨é“¾è¡¨ä¸²åœ¨ä¸€èµ·ã€‚

![image-20220203123625662](images/image-20220203123625662.png)

###### Extendible Hashing

ä¸»è¦æ€æƒ³æ˜¯é€šè¿‡ä¸€ä¸ªå…¨å±€counteræ¥ç¡®å®šæœ‰å¤šå°‘ä½bitæ¥å†³å®šå…ƒç´ åº”è¯¥å¤„äºå“ªä¸ªbucketï¼Œæ¯ä¸ªbucketæœ‰ä¸€ä¸ªå±€éƒ¨counterï¼Œæ‰¾åˆ°bucketæ”¾å…¥æˆ–è€…åœ¨bucketé¡ºåºæ‰«æå³å¯ï¼Œå…·ä½“å¯ä»¥çœ‹è¿™ä¸ªåšå®¢ï¼š

https://blog.csdn.net/whynottrythis/article/details/109566391

![image-20220203124446609](images/image-20220203124446609.png)

###### Linear Hashing

ä¸åŒäºExtendible Hashingï¼Œè¿™ä¸ªåˆ†è£‚bucketæ¥æ‰©å±•ç©ºé—´æ˜¯æŒ‰ç€pointerå¾ªç¯åˆ†è£‚çš„ã€‚

(è¯´å®è¯ï¼Œå¹¶æ²¡æœ‰æ€ä¹ˆæ‡‚ï¼ŒğŸçš„åé¢å†æ¥çœ‹)

![image-20220203153948605](images/image-20220203153948605.png)![image-20220203154758799](images/image-20220203154758799.png)



## 4. Table Index

![image-20220205115107509](images/image-20220205115107509.png)

![image-20220205115500253](images/image-20220205115500253.png)

### 4.1 B-Tree Overview

![image-20220205115905034](images/image-20220205115905034.png)

#### 4.1.1 B+Tree

![image-20220205120253018](images/image-20220205120253018.png)

##### B+Tree ç‰¹æ€§

![image-20220205120618788](images/image-20220205120618788.png)

![image-20220205121156624](images/image-20220205121156624.png)

##### nodes

![image-20220205121116932](images/image-20220205121116932.png)

![image-20220205121445609](images/image-20220205121445609.png)

![image-20220205121513634](images/image-20220205121513634.png)

##### B-Tree VS B+Tree

![image-20220206105718324](images/image-20220206105718324.png)

##### B+Tree Insert

è¿™é‡Œæœ‰ä¸€ä¸ªä¸é”™çš„æ¼”ç¤ºç½‘ç«™:[B+ Tree Visualization (usfca.edu)](https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html)

![image-20220206111755539](images/image-20220206111755539.png)

##### B+Tree Delete

![image-20220206112104483](images/image-20220206112104483.png)

##### Variabel Length keys

![image-20220208230531943](images/image-20220208230531943.png)

![image-20220208231609967](images/image-20220208231609967.png)

##### Non-Unique Indexs

æˆ‘ä»¬å¯ä»¥ç”¨ä¸¤ç§æ–¹æ³•æ¥å¤„ç†éå”¯ä¸€ç´¢å¼•:

* Duplicate Keys
* Value Lists

![image-20220208231802149](images/image-20220208231802149.png)

![image-20220208232044719](images/image-20220208232044719.png)

![image-20220209111116376](images/image-20220209111116376.png)

![image-20220208232059178](images/image-20220208232059178.png)

![image-20220209120517208](images/image-20220209120517208.png)

##### Intra-node Search

* Linear
* Binary
* Interpolation

![image-20220208233104791](images/image-20220208233104791.png)

##### Optimizations

* Prefix Compression
* Suffix Truncation
* Bulk Insert
* Pointer Swizzing

![image-20220208233713884](images/image-20220208233713884.png)

![image-20220208233915955](images/image-20220208233915955.png)

![image-20220208234112618](images/image-20220208234112618.png)

![image-20220208235308754](images/image-20220208235308754.png)



### 4.2 Indexs

#### 4.2.1 Implicit Indexs

å½“æˆ‘ä»¬åˆ›å»ºè¡¨çš„æ—¶å€™ï¼ŒDBMSä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºä¸€äº›ç´¢å¼•

![image-20220209160433366](images/image-20220209160433366.png)

#### 4.2.2 Partial Indexs

ä¸ºæ•°æ®é›†ä¸Šçš„éƒ¨åˆ†æ•°æ®åšç´¢å¼•ï¼ˆæ¯”å¦‚åªå¯¹æœ¬æœˆæ•°æ®åšç´¢å¼•ï¼‰ï¼Œå¯ä»¥åŠ å¿«ç´¢å¼•çš„é€Ÿåº¦ã€‚

![image-20220209160836409](images/image-20220209160836409.png)

#### 4.2.3 Covering Indexs

![image-20220209161402845](images/image-20220209161402845.png)

#### 4.2.4 Index Include Columns

![image-20220209161724043](images/image-20220209161724043.png)

#### 4.2.5 Function/Expression Indexs

![image-20220209162354190](images/image-20220209162354190.png)

#### 4.2.6 Trie Index

åœ¨B+æ ‘ä¸­ï¼Œå®ƒæ— æ³•å‘Šè¯‰ä½ ä¸€ä¸ªç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼Œè¿™æ„å‘³ç€ä½ å¿…é¡»åˆ°å¶å­èŠ‚ç‚¹æ‰èƒ½çŸ¥é“æ˜¯å¦ç´¢å¼•å­˜åœ¨ã€‚

![image-20220209170231248](images/image-20220209170231248.png)

æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç§ç´¢å¼•: trie index

![image-20220209170603002](images/image-20220209170603002.png)

##### Trie index properties

![image-20220209171605563](images/image-20220209171605563.png)

##### Trie key span

![image-20220209171839543](images/image-20220209171839543.png)

##### Radix Tree

![image-20220209174025508](images/image-20220209174025508.png)

![image-20220209174051004](images/image-20220209174051004.png)



## 5. Multi-Threaded Index Concurrency Control

![image-20220212112100022](images/image-20220212112100022.png)

### 5.1 Locks VS Latches

åœ¨æ•°æ®åº“å±‚é¢ï¼Œlocksæ˜¯ä¸€ç§æ›´é«˜çº§çš„è¡¨ç¤ºï¼Œå®ƒä¿æŠ¤äº†æ•°æ®åº“ä¸­çš„é€»è¾‘å†…å®¹(æ¯”å¦‚ä¸€ä¸ªtupleï¼Œä¸€å¼ è¡¨æˆ–è€…æ•´ä¸ªæ•°æ®åº“ç­‰ç­‰)ï¼Œå½“åŒä¸€æ—¶é—´æœ‰å…¶ä»–äº‹åŠ¡åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¼šç”¨è¿™äº›lockæ¥ä¿æŠ¤é€»è¾‘å¯¹è±¡ã€‚

åœ¨ä½çº§å±‚é¢ï¼Œæˆ‘ä»¬æ‰€å…³å¿ƒçš„å°±æ˜¯ç”¨æ¥ä¿æŠ¤æ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„ç‰©ç†å®Œæ•´æ€§çš„latchï¼Œlatchä¼šå»ä¿æŠ¤æ•°æ®åº“ç³»ç»Ÿçš„å…³é”®éƒ¨åˆ†ï¼Œå³ä¿æŠ¤å†…éƒ¨æ•°æ®ç»“æ„å…å—å…¶ä»–çº¿ç¨‹å¯¹è¯¥æ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡åŒä¸€æ—¶åˆ»è¿›è¡Œè¯»å†™æ‰€å¸¦æ¥çš„é—®é¢˜ã€‚å› æ­¤æˆ‘ä»¬åªä¼šåœ¨ä¸€å°éƒ¨åˆ†æ—¶é—´æŒæœ‰latchï¼Œåªä¼šåœ¨å…³é”®éƒ¨åˆ†è¿›è¡Œæ‰€éœ€æ“ä½œçš„æ—¶å€™æŒæœ‰è¿™ä¸ªlatchã€‚æ¯”å¦‚å¯¹ä¸€ä¸ªpageè¿›è¡Œä¿®æ”¹çš„æ—¶å€™ã€‚

![image-20220212113420197](images/image-20220212113420197.png)

![image-20220212113435443](images/image-20220212113435443.png)

#### 5.1.1 Latch Mode

![image-20220212114951060](images/image-20220212114951060.png)

#### 5.1.2 Latch Implementations

æ–¹æ³•ä¸€: ä½¿ç”¨OSå±‚é¢çš„mutex

![image-20220212115418536](images/image-20220212115418536.png)

æ–¹æ³•äºŒï¼šTest-and-Set Spin Latch

![image-20220212142848314](images/image-20220212142848314.png)

æ–¹æ³•ä¸‰: Read-Write Latch

![image-20220212143535283](images/image-20220212143535283.png)

#### 5.1.3 Hash Table Latching

![image-20220212144809262](images/image-20220212144809262.png)

![image-20220212145052727](images/image-20220212145052727.png)

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå¦‚ä½•åœ¨hash tableä¸­ä½¿ç”¨latchï¼ˆpage latchå’Œslot latchï¼‰

<center class="half">    
    <img src="images/image-20220212145842441.png" width="600"/>    
    <img src="images/image-20220212150309509.png" width="600"/> 
</center>


### 5.2 B+ Tree Concurrency Control

![image-20220216115335556](images/image-20220216115335556.png)

#### 5.2.1 Latch Crabbing/Coupling

![image-20220216115646742](images/image-20220216115646742.png)

å…·ä½“åšæ³•å¦‚ä¸‹ï¼š

* å¯¹äºè¯»æ“ä½œï¼šæˆ‘ä»¬æ¯æ¬¡è·å¾—å­©å­çš„ä¸€ä¸ªRé”ï¼Œè¿›å…¥åˆ°å­©å­èŠ‚ç‚¹ï¼Œç„¶åé‡Šæ”¾çˆ¶èŠ‚ç‚¹çš„é”
* å¯¹äºå†™æ“ä½œï¼šæˆ‘ä»¬æ¯æ¬¡è·å¾—å­©å­çš„ä¸€ä¸ªWé”ï¼Œè¿›å…¥åˆ°å­©å­èŠ‚ç‚¹å¹¶æ£€æŸ¥è¯¥èŠ‚ç‚¹æ˜¯å¦safeï¼Œå¦‚æœsafeåˆ™é‡Šæ”¾ç¥–å…ˆèŠ‚ç‚¹çš„æ‰€æœ‰é”ã€‚(å› ä¸ºå­©å­èŠ‚ç‚¹safeè¡¨æ˜äº†ä¸ä¼šå¯¹ç¥–å…ˆèŠ‚ç‚¹äº§ç”Ÿåˆ†è£‚æˆ–è€…åˆå¹¶æ“ä½œ)

![image-20220216120953386](images/image-20220216120953386.png)

#### 5.2.2 Better Latching Algorithm

æˆ‘ä»¬å¯ä»¥å‡è®¾åœ¨å®é™…ä¸­æ’å…¥/åˆ é™¤çš„æ¬¡æ•°å¹¶ä¸å¤šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆç”¨Ré”åœ¨éå†Inner-nodeçš„æ—¶å€™ï¼Œç›´åˆ°leaf-nodeæˆ‘ä»¬æ‰ç”¨Wé”ï¼Œå¦‚æœæ­¤æ—¶leaf-nodeå¹¶ä¸éœ€è¦æ‹†åˆ†/åˆå¹¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬èµŒå¯¹äº†ï¼Œå‰é¢çš„èŠ‚ç‚¹éƒ½ä¸ç”¨å˜åŒ–ï¼Œåä¹‹æˆ‘ä»¬å°±é‡æ–°ä»æ ¹èŠ‚ç‚¹å¼€å§‹å†æ¬¡éå†ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹éƒ½ç”¨Wé”ã€‚è¿™å°±æ˜¯ä¹è§‚é”æœºåˆ¶ã€‚

![image-20220216154314250](images/image-20220216154314250.png)

#### 5.2.3 Leaf Node Scan

åœ¨å‰é¢çš„éå†/ä¿®æ”¹ä¸­ï¼Œç”±äºæˆ‘ä»¬å§‹ç»ˆæ˜¯ä»ä¸Šåˆ°ä¸‹çš„æ“ä½œï¼Œæ‰€ä»¥å¹¶ä¸ä¼šå¼•èµ·æ­»é”çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨B+Treeä¸­æˆ‘ä»¬è¿˜å¯ä»¥å¯¹leaf-nodeè¿›è¡Œå·¦å³éå†ä»è€Œå®ç°èŒƒå›´æŸ¥è¯¢ï¼Œè¿™æ ·å°±æœ‰å¯èƒ½å‡ºç°å¯¹åŒä¸€ä¸ªèŠ‚ç‚¹äº‰æŠ¢çš„æƒ…å†µï¼Œå³æ­»é”ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•å°±æ˜¯ï¼šå½“çº¿ç¨‹Aå·¦å³éå†leaf-nodeæ—¶å¦‚æœå–ä¸åˆ°latchï¼Œé‚£ä¹ˆå°±è®©çº¿ç¨‹Aé‡æ–°æ‰§è¡ŒåŸæ“ä½œ(æ¯”å¦‚ä»å¤´è¿›è¡ŒæŸ¥è¯¢)ã€‚äº‹å®ä¸Šï¼Œé‡æ–°æ‰§è¡Œæ¯”è¶…æ—¶é‡è¯•å¯èƒ½æ›´å¥½ï¼Œåªè¦ä¸€ç›´é‡æ–°æ‰§è¡Œï¼Œæˆ‘ä»¬æ€»èƒ½é¢„æœŸè·å¾—ä¸€ä¸ªç»“æœã€‚

![image-20220216161236698](images/image-20220216161236698.png)

![image-20220216161404042](images/image-20220216161404042.png)

#### 5.2.4 Delayed Parent Updates

å½“ä¸€ä¸ªleaf-nodeéœ€è¦è¢«splitçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä»…ä»…åªå¯¹å®ƒè¿›è¡Œæ‹†åˆ†ï¼Œè€Œå¯¹çˆ¶äº²èŠ‚ç‚¹çš„å½±å“ç•™åˆ°åé¢æ¥åšã€‚è¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦é‡æ–°å¼€å§‹å¹¶æ‹¿ç€write latchä¸€è·¯å¾€ä¸‹éå†äº†ã€‚(ä»ç„¶æ˜¯ä¹è§‚é”æœºåˆ¶)

![image-20220216162824589](images/image-20220216162824589.png)

ä¸¾ä¸ªä¾‹å­ï¼š

![image-20220216163024820](images/image-20220216163024820.png)



## 6. Sorting + Aggregations

åœ¨å­¦ä¹ è¿™ä¸ªä¹‹é—´ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥æ•´ä½“çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯æŸ¥è¯¢è®¡åˆ’

![image-20220217114205237](images/image-20220217114205237.png)

### 6.1 Sorting

#### 6.1.1 Why Need Sort

![image-20220217114243942](images/image-20220217114243942.png)

#### 6.1.2 External Merge Sort

è€ƒè™‘åˆ°æœ‰å¯èƒ½å†…å­˜æ— æ³•è£…ä¸‹æ‰€æœ‰pageï¼Œå› æ­¤ä¼ ç»Ÿçš„æ’åºç®—æ³•æ˜¯ä¸èƒ½ç›´æ¥åº”ç”¨çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç”¨å¤–éƒ¨æ’åºã€‚

![image-20220217114752165](images/image-20220217114752165.png)

##### 2-Way External Merge Sort

![image-20220217114842831](images/image-20220217114842831.png)

![image-20220217120119566](images/image-20220217120119566.png)

![image-20220217120440241](images/image-20220217120440241.png)

å¯¹äºäºŒè·¯å¤–éƒ¨å½’å¹¶æ’åºæ¥è¯´ï¼Œä¸€ä¸ªç®€å•çš„ä¼˜åŒ–å°±æ˜¯å¯¹pageè¿›è¡Œé¢„å–

![image-20220217121202282](images/image-20220217121202282.png)

å½“ç„¶å¯¹äºå¤šè·¯å½’å¹¶æ’åºæˆ‘ä»¬åŒæ ·ä¹Ÿå¯ä»¥åšå‡ºæ‹“å±•

![image-20220217121724047](images/image-20220217121724047.png)

#### 6.1.3 Using B+Trees For Sorting

![image-20220217185251026](images/image-20220217185251026.png)

![image-20220217185304139](images/image-20220217185304139.png)

![image-20220217185312563](images/image-20220217185312563.png)

æ€»çš„æ¥è¯´ï¼Œå¦‚æœè¿™æ˜¯ä¸€ä¸ªclustered indexï¼ŒæŸ¥è¯¢éœ€è¦æ ¹æ®ç´¢å¼•æ‰€åŸºäºçš„keyå¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨B+æ ‘è¿›è¡Œæ’åºæ˜¯éå¸¸å¥½çš„ï¼Œå¦åˆ™å¦‚æœä¸æ˜¯ä¸€ä¸ªclustered indexï¼Œé‚£ä¹ˆå°±æ”¾å¼ƒè¿™ç§æƒ³æ³•å§ã€‚



### 6.2 Aggregations

![image-20220223150036740](images/image-20220223150036740.png)

#### 6.2.1 Sorting Aggregation

å¯ä»¥å…ˆè¿›è¡Œè¿‡æ»¤ï¼Œç„¶åå»æ‰ä¸éœ€è¦çš„åˆ—ï¼Œç„¶åé€šè¿‡æ’åºè¿›è¡Œèšåˆã€‚

![image-20220223150737775](images/image-20220223150737775.png)

#### 6.2.2 Hashing Aggregation

![image-20220223152726581](images/image-20220223152726581.png)

å¦‚æœå†…å­˜æ»¡äº†ï¼ŒDBMSä¸å¾—ä¸å°†æ•°æ®å†™å›ç£ç›˜ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”¨åˆ°å¤–éƒ¨hashèšåˆã€‚

![image-20220223153043740](images/image-20220223153043740.png)

##### Partition

![image-20220223153420552](images/image-20220223153420552.png)

![image-20220223153432263](images/image-20220223153432263.png)

##### Rehashing

å†æ¬¡hashçš„ç›®çš„æ˜¯ï¼šå› ä¸ºç¬¬ä¸€æ¬¡hashä¿è¯äº†keyçš„å±€éƒ¨æ€§ï¼Œå³ç›¸åŒçš„keyåªä¼šå­˜åœ¨åŒä¸€ä¸ªåˆ†åŒºï¼Œä½†æ˜¯ä¸€ä¸ªåˆ†åŒºå¯èƒ½åŒ…å«ä¸åŒçš„keyï¼Œå†æ¬¡hashå°±æ˜¯å¯¹æ¯ä¸ªåˆ†åŒºçš„keyè®¡ç®—èšåˆç»“æœäº†ã€‚

![image-20220223154414138](images/image-20220223154414138.png)

![image-20220223155109135](images/image-20220223155109135.png)

#### 6.2.3 Hashing Summarization

![image-20220223155810559](images/image-20220223155810559.png)

![image-20220223155821030](images/image-20220223155821030.png)

#### 6.2.4 Cost Analysis

![image-20220223160119372](images/image-20220223160119372.png)

#### 6.2.5 Conclusion

![image-20220223160303851](images/image-20220223160303851.png)



## 7. Join Algorithm

![image-20220223170838144](images/image-20220223170838144.png)

ä¸‹é¢æˆ‘ä»¬ä¼šè®¨è®ºè¿™å‡ ä¸ªé—®é¢˜ï¼š

* Join Operator Output Data
* I/O Cost Analysis
* Join Vs Cross-Product

 Join Operator Output Data

![image-20220223174613059](images/image-20220223174613059.png)

![image-20220223174645666](images/image-20220223174645666.png)

I/O Cost Analysis

![image-20220223174931493](images/image-20220223174931493.png)

Join Vs Cross-Product

![image-20220223175100066](images/image-20220223175100066.png)

ä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“ä»‹ç»ä¸‰ä¸ªjoinç›¸å…³çš„ç®—æ³•

* Nested Loop Join
* * Simple/Stupid
  * Block
  * Index
* Sort-Merge Join
* Hash join

### 7.1 Nested Loop Join

#### 7.1.1 Stupid Nested Loop Join

![image-20220223193512588](images/image-20220223193512588.png)

![image-20220223193557778](images/image-20220223193557778.png)

#### 7.1.2 Block Nested Loop Join

![image-20220223193932218](images/image-20220223193932218.png)

![image-20220223194443926](images/image-20220223194443926.png)

ä¸€ä¸ªæ”¹è¿›æ˜¯å¦‚æœå†…å­˜æä¾›**B**ä¸ªbuffersï¼Œåˆ™æˆ‘ä»¬å¯ä»¥å°†**B-2**ä¸ªbufferç”¨äºè¯»å–outer pageï¼Œ1ä¸ªbufferè¯»å–inner pageï¼Œä¸€ä¸ªbufferç”¨äºè¾“å‡º

![image-20220223203207146](images/image-20220223203207146.png)

![image-20220223203455640](images/image-20220223203455640.png)

å¦ä¸€ä¸ªæ”¹è¿›æ˜¯å¯¹æŸä¸€åˆ—è¿›è¡Œç´¢å¼•ï¼Œè¿™æ ·ä¼šåŠ å¿«æˆ‘ä»¬æŸ¥æ‰¾çš„é€Ÿåº¦

![image-20220223204332652](images/image-20220223204332652.png)

![image-20220223204404708](images/image-20220223204404708.png)

æ€»ç»“ä¸€ä¸‹

![image-20220223204755571](images/image-20220223204755571.png)



### 7.2 Sort-Merge Join

![image-20220223205449677](images/image-20220223205449677.png)

ä¸‹é¢ç»™å‡ºä¸€ç§è¿‘ä¼¼ç®—æ³•æè¿°

![image-20220223210334337](images/image-20220223210334337.png)

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæœ‰å¯èƒ½è§¦å‘Inner joinçš„å›æº¯ï¼Œæ¯”å¦‚Rè¡¨æœ‰ä¸¤ä¸ªAå€¼ï¼ŒSè¡¨ä¹Ÿæœ‰ä¸¤ä¸ªAå€¼ï¼ŒRA1ä¼šåŒ¹é…åˆ°SA1å’ŒSA2ï¼Œç„¶åSæ¸¸æ ‡ç§»åŠ¨åˆ°SA2çš„ä¸‹ä¸€ä¸ªä½ç½®çš„æ—¶å€™ï¼Œå‘ç°æ¯”RA1å¤§ï¼Œåˆ™Rçš„æ¸¸æ ‡å¾€ä¸‹ç§»åŠ¨å¾—åˆ°RA2ï¼Œå‘ç°æ•°å€¼ä¸RA1ç›¸åŒï¼Œåˆ™éœ€è¦å¯¹Sçš„æ¸¸æ ‡å›æº¯åˆ°SA1é‡æ–°è¿›è¡ŒåŒ¹é…è¿™ä¸ªæ­¥éª¤ã€‚

å¯¹åº”çš„æ—¶é—´å¤æ‚åº¦åˆ†æ

![image-20220223212400752](images/image-20220223212400752.png)

å½“ç„¶å¦‚æœRè¡¨å’ŒSè¡¨å¯¹åº”è¿æ¥çš„åˆ—å€¼å…¨éƒ¨ä¸€æ ·å°±é€€åŒ–ä¸ºäº†Nested Loop Join



### 7.3 Hash Join

![image-20220223213724009](images/image-20220223213724009.png)

![image-20220223213712485](images/image-20220223213712485.png)

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç®—æ³•æè¿°å’Œæ¼”ç¤º

![image-20220223214122841](images/image-20220223214122841.png)

å½“hash tableè¿‡å¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹inner pageå…ˆåšä¸€æ¬¡bloom filterï¼Œå…ˆåˆ¤å®šå¾…æŸ¥è¯¢çš„å€¼æ˜¯å¦åœ¨

hash tableä¸­ï¼Œè¿™æ ·å¯ä»¥å‡å°‘I/Oæ¬¡æ•°ï¼ˆ[è¯¦è§£å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†ï¼Œä½¿ç”¨åœºæ™¯å’Œæ³¨æ„äº‹é¡¹ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/43263751)ï¼‰

#### 7.3.1 Grace Hash Join

å½“ä¸¤ä¸ª table éƒ½æ— æ³•æ”¾å…¥ memory æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

- Phase #1: Build
  - å°†ä¸¤ä¸ª tables ä½¿ç”¨åŒæ ·çš„ hash function è¿›è¡Œ partitionï¼Œä½¿å¾—å¯èƒ½é…å¯¹æˆåŠŸçš„ tuples è¿›å…¥åˆ°ç›¸åŒçš„Partition
- Phase #2: Prob
  - å¯¹ä¸¤ä¸ª tables çš„æ¯ä¸€å¯¹ partition åˆ†åˆ«è¿›è¡Œ Join

![img](images/assets%2F-LMjQD5UezC9P8miypMG%2F-La89KlvadrrXRPkyto_%2F-La8RpW98dA7RvGFMYhB%2FScreen Shot 2019-03-17 at 10.20.23 AM.jpg)

å¦‚æœæ¯ä¸ª partition ä»ç„¶æ— æ³•æ”¾å…¥å†…å­˜ä¸­ï¼Œåˆ™å¯ä»¥é€’å½’åœ°ä½¿ç”¨ä¸åŒçš„ hash function è¿›è¡Œ partitionï¼Œå³ recursive partitioningï¼š

![img](images/assets%2F-LMjQD5UezC9P8miypMG%2F-La89KlvadrrXRPkyto_%2F-La8SCV9GrYuISXphOsN%2FScreen Shot 2019-03-17 at 10.22.02 AM.jpg)

æˆæœ¬åˆ†æï¼š

å‡è®¾æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„ buffers èƒ½å¤Ÿå­˜ä¸‹ä¸­é—´ç»“æœï¼š

- Partitioning Phase:
  - Read + Write both tables
  - 2(M+N) I/Os
- Probing Phase
  - Read both tables
  - M+N I/Os



### 7.4 æ€»ç»“

![image-20220223223840772](images/image-20220223223840772.png)



## 8. Query Execution

### 8.1 Processing Model

ä¸€ä¸ªæ‰§è¡Œæ¨¡å‹(processing model)å†³å®šäº†DBMSå¦‚ä½•å»æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢è®¡åˆ’ã€‚ä¸‹é¢æœ‰ä¸‰ç§æ–¹æ³•:

* Iterator Model
* Materialization Model
* Vectorized/Batch Model

#### 8.1.1 Iterator Model

![image-20220302113511174](images/image-20220302113511174.png)

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæ„Ÿè§‰å’ŒMIT 6.830çš„è¿­ä»£å™¨æ¨¡å‹å¾ˆåƒ

![image-20220302114019810](images/image-20220302114019810.png)

æ€»ç»“ä¸€ä¸‹

![image-20220302114829011](images/image-20220302114829011.png)

#### 8.1.2 Materialization Model

å’ŒIterator Modelä¸åŒçš„æ˜¯ï¼Œä¸æ˜¯æ¯æ¬¡è¿”å›ä¸€æ¡tupleï¼Œè€Œæ˜¯è¿”å›æ‰€æœ‰çš„tuplesç»™ä¸Šå±‚å¤„ç†ã€‚

![image-20220302115427039](images/image-20220302115427039.png)

å¯ä»¥çœ‹ä¸‹å›¾ï¼Œæ¯æ¬¡è¾“å‡ºéƒ½æ˜¯ä¸€ä¸ªout bufferï¼Œè€Œä¸æ˜¯single tuple

![image-20220302115658834](images/image-20220302115658834.png)

#### 8.1.3 Vectorization Model

å’ŒIterator Modelä¸åŒçš„æ˜¯ï¼Œæ¯æ¬¡è¿”å›ä¸€æ‰¹tuples(a batch tuples)

![image-20220302121027298](images/image-20220302121027298.png)



### 8.2 Plan Processing Direction

* Top-to-Bottom
* Bottom-to-Top

![image-20220302121836360](images/image-20220302121836360.png)



### 8.3 Access Methods

![image-20220307154756543](images/image-20220307154756543.png)

#### 8.3.1 Sequential Scan

![image-20220307154824190](images/image-20220307154824190.png)

#### 8.3.2 Index Scan

![image-20220307164255427](images/image-20220307164255427.png)

#### 8.3.3 Multi-Index Scan

![image-20220307164341065](images/image-20220307164341065.png)



### 8.4 Process Model

![image-20220307171925741](images/image-20220307171925741.png)

ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹å¼

* Process per DBMS Worker
* Process Pool
* Thread per DBMS Worker

#### 8.4.1 Process per DBMS Worker

![image-20220307173835187](images/image-20220307173835187.png)

#### 8.4.2 Process Pool

![image-20220307174406067](images/image-20220307174406067.png)

#### 8.4.3 Thread per DBMS Worker

![image-20220307200432569](images/image-20220307200432569.png)



### 8.5 Inter-Query And Intra-Query

![image-20220307201031409](images/image-20220307201031409.png)

#### 8.5.1 Inter-Query Parallelism

![image-20220307201120764](images/image-20220307201120764.png)

#### 8.5.2 Intra-Query Parallelism

![image-20220307201429301](images/image-20220307201429301.png)

ä¸‹é¢æœ‰ä¸‰ç§æ–¹æ³•æ¥è¿›è¡Œintra-query parallelism

* Intra-Operator(Horizontal)
* Inter-Operator(Vertical)
* Bushy

##### Intra-Operator(Horizontal)

![image-20220307202834884](images/image-20220307202834884.png)

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼ŒExchange Operatorè°ƒç”¨ä¸‰ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œç›¸åŒæ“ä½œ

![image-20220307203716671](images/image-20220307203716671.png)

Exchange Operatorçš„ä¸åŒç±»å‹

![image-20220307204711234](images/image-20220307204711234.png)

![image-20220307204948972](images/image-20220307204948972.png)

##### Inter-Operator(Vertical)

![image-20220307205231911](images/image-20220307205231911.png)

ä¸‹é¢æ¥çœ‹ä¸ªä¾‹å­(å¥½å§æˆ‘å¹¶æ²¡æœ‰æ€ä¹ˆæ‡‚è¿™ä¸ªç©æ„å„¿...)

![image-20220307205905155](images/image-20220307205905155.png)

##### Bushy

![image-20220307210237860](images/image-20220307210237860.png)



### 8.6 Conclusion

![image-20220307214020490](images/image-20220307214020490.png)



## 9. Query Planning & Optimization

![image-20220308171416460](images/image-20220308171416460.png)

![image-20220308171441659](images/image-20220308171441659.png)

### 9.1 Heuristics/Rules

![image-20220308172650012](images/image-20220308172650012.png)

#### 9.1.1 Predicate Pushdown

æ ¸å¿ƒæ€æƒ³ï¼šå…ˆè¿›è¡Œfilterï¼Œå†è¿›è¡Œjoin

![image-20220308173101553](images/image-20220308173101553.png)

![image-20220308173906429](images/image-20220308173906429.png)

#### 9.1.2 Projection

æ ¸å¿ƒæ€æƒ³ï¼šå°½æ—©çš„projections

![image-20220308174453772](images/image-20220308174453772.png)

![image-20220308174729044](images/image-20220308174729044.png)



### 9.2 Cost-based Search

#### 9.2.1 Statistics

![image-20220309171825585](images/image-20220309171825585.png)

#### 9.2.2 Derivable Statistics

![image-20220309171916402](images/image-20220309171916402.png)

#### 9.2.3 Complex Predicate

![image-20220309172005312](images/image-20220309172005312.png)

![image-20220309172037676](images/image-20220309172037676.png)

![image-20220309172048749](images/image-20220309172048749.png)

![image-20220309172103380](images/image-20220309172103380.png)

![image-20220309172113940](images/image-20220309172113940.png)

#### 9.2.4 Cost Estimations

ä¸€ç§æ–¹æ³•æ˜¯æ ¹æ®ç›´æ–¹å›¾æ¥ä¼°è®¡é€‰æ‹©ç‡ï¼Œå¦ä¸€ç§æ–¹æ³•æ˜¯å¯¹æ•°æ®åº“è¿›è¡Œé‡‡æ ·æ¥ä¼°è®¡é€‰æ‹©ç‡ã€‚è¿™é‡Œåªåˆ—å‡ºäº†å¦‚ä½•åˆ©ç”¨ç›´æ–¹å›¾è¿›è¡Œé€‰æ‹©ç‡çš„ä¼°è®¡ã€‚

![image-20220309175607382](images/image-20220309175607382.png)

![image-20220309175618305](images/image-20220309175618305.png)

åŒºé—´ç›´æ–¹å›¾ï¼ŒæŒ‰ç…§ç›¸åŒçš„èŒƒå›´åˆ’åˆ†bucket

![image-20220309175652571](images/image-20220309175652571.png)



![image-20220309175700592](images/image-20220309175700592.png)

æŒ‰ç…§å°½å¯èƒ½æ¥è¿‘çš„æ•°å€¼æ€»å’Œåˆ’åˆ†bucket

![image-20220309175841138](images/image-20220309175841138.png)

![image-20220309175850428](images/image-20220309175850428.png)

#### 9.2.5 Candidate Plan

è¿™é‡Œä¸»è¦è®²çš„æ˜¯å¤šè¡¨è¿æ¥çš„æ—¶å€™å¦‚ä½•é€‰æ‹©æœ€åçš„è¿æ¥æ–¹å¼ä»è€Œå¾—åˆ°æœ€å¥½çš„æ•ˆç‡ï¼Œå› ä¸ºæ— è®ºè¿æ¥é¡ºåºå¦‚ä½•ï¼Œå¾—åˆ°çš„ç»“æœæ€»æ˜¯ä¸€æ ·çš„ã€‚

![image-20220309213910898](images/image-20220309213910898.png)

![image-20220309213927136](images/image-20220309213927136.png)

![image-20220309213937594](images/image-20220309213937594.png)

![image-20220309213950709](images/image-20220309213950709.png)

æœ‰è¶£çš„æ˜¯ï¼Œåœ¨Postgres Optimizerä¸­ï¼Œå¦‚æœè¿æ¥çš„è¡¨ï¼13ï¼Œä¼šé‡‡ç”¨ä¸€ç§æ¨¡æ‹Ÿé€€ç«çš„ç®—æ³•æ¥è·å¾—è¿‘ä¼¼æœ€ä¼˜è§£ã€‚

#### 9.2.6 Nested Sub-Queries: Decompose

æ ¸å¿ƒæ€æƒ³ï¼šå°†åµŒå¥—æŸ¥è¯¢å…ˆåšï¼Œå¹¶å°†ç»“æœä¿å­˜ä¸ºä¸€ä¸ªå˜é‡ã€‚

![image-20220309215118242](images/image-20220309215118242.png)

![image-20220309215133603](images/image-20220309215133603.png)



### 9.3 Conclusion

![image-20220309215159999](images/image-20220309215159999.png)



## 10. Concurrency Control Thoeory

### 10.1 Transaction

å…³äºäº‹åŠ¡æ¦‚å¿µå°±ä¸è¿‡å¤šèµ˜è¿°ï¼Œä¸»è¦æ˜¯æ»¡è¶³ACIDç‰¹æ€§ã€‚

![image-20220310211824155](images/image-20220310211824155.png)

![image-20220310211905322](images/image-20220310211905322.png)

#### 10.1.1 Atomicity

![image-20220310212016282](images/image-20220310212016282.png)

##### Mechanisms For Ensuring Atomicity

![image-20220310212249432](images/image-20220310212249432.png)

![image-20220310212543965](images/image-20220310212543965.png)

#### 10.1.2 Consistency

![image-20220310213629851](images/image-20220310213629851.png)

#### 10.1.3 Isolation

![image-20220310214411970](images/image-20220310214411970.png)

##### Mechanisms For Ensuring Isolation

![image-20220310214515735](images/image-20220310214515735.png)

#### 10.1.4 Others

è‡³äºæŒä¹…æ€§ï¼Œè¿™ä¸ªé—®é¢˜æ”¾åˆ°äº†æ—¥å¿—é‚£ä¸€éƒ¨åˆ†æ¥è®²ã€‚åé¢è¿˜è®²äº†äº‹åŠ¡çš„åºåˆ—åŒ–ä»¥åŠå†²çªç›¸å…³çŸ¥è¯†ï¼Œè·Ÿæ•™æä¸Šè®²çš„åŸºæœ¬ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†™å‡ºæ¥äº†ã€‚

è¿™é‡Œæä¸€ä¸‹ç”¨å¾ªç¯ç­‰å¾…å›¾æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å†²çªå¯åºåˆ—åŒ–çš„

![image-20220310222615778](images/image-20220310222615778.png)



### 10.2 Conclusion

![image-20220310222640173](images/image-20220310222640173.png)



## 11. Two-Phase Locking Concurrency Control

### 11.1 Basic Look Types

![image-20220311205230954](images/image-20220311205230954.png)

### 11.2 Executing With Locks

![image-20220311205351551](images/image-20220311205351551.png)

### 11.3 Concurrency Control Protocol

![image-20220311205649181](images/image-20220311205649181.png)

#### 11.3.1 Tow-Phase Locking

![image-20220311210026371](images/image-20220311210026371.png)

![image-20220311210126749](images/image-20220311210126749.png)

#### 11.3.2 String Strict Two=Phase Locking

ç®€å•æ¥è¯´ï¼šé”çš„é‡Šæ”¾åªä¼šåœ¨äº‹åŠ¡æäº¤/ä¸¢å¼ƒé˜¶æ®µï¼Œè€Œä¸ä¼šå‡ºç°é‡Šæ”¾æ‰€ä»¥åè¿˜ä¼šå¯¹pageè¿›è¡ŒæŸäº›æ“ä½œ

![image-20220311212016086](images/image-20220311212016086.png)

#### 11.3.3 2PL Deadlocks

![image-20220311212717046](images/image-20220311212717046.png)

![image-20220311212800140](images/image-20220311212800140.png)

#### 11.3.4 DeadLock Handling

##### Victim Selection

![image-20220311213608966](images/image-20220311213608966.png)

##### Rollback Length

![image-20220311213637244](images/image-20220311213637244.png)

#### 11.3.5 Timestamp Ordering(T/O)

![image-20220311214357202](images/image-20220311214357202.png)

##### Timestamp Allocation

![image-20220311214500727](images/image-20220311214500727.png)

#### 11.3.6 Basic T/O

![image-20220311215522210](images/image-20220311215522210.png)

##### Reads

![image-20220311220213419](images/image-20220311220213419.png)

##### Writes

![image-20220311220228423](images/image-20220311220228423.png)

##### Thomas Write Rule

![image-20220311221831676](images/image-20220311221831676.png)

